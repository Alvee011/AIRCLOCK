<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIRCLOCK - On Time Worldwide</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏰</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://worldtimeapi.org">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js" defer></script>

    <style>
        :root {
    --bg-light: #e5e7eb; /* Light mode background color */
    --text-light: #2c3e50; /* Light mode text color */
    --bg-dark: #000000; /* Dark mode background color */
    --text-dark: #ecf0f1; /* Dark mode text color */
    --accent-light: #D4AF37; /* Golden accent for light mode */
    --accent-dark: #FFD700;  /* Golden accent for dark mode */
    --card-bg-light: #ffffff; /* Card background in light mode */
    --card-bg-dark: #1F1F1F; /* Card background in dark mode (deeper) */
    --shadow-light: 0 8px 25px rgba(0, 0, 0, 0.1); /* Shadow for light mode elements */
    --shadow-dark: 0 8px 25px rgba(0, 0, 0, 0.3); /* Shadow for dark mode elements */
    --border-light: rgba(0, 0, 0, 0.1); /* Border color in light mode */
    --border-dark: rgba(255, 255, 255, 0.1); /* Border color in dark mode */
    --btn-bg-light: #f3f4f6;
    --btn-bg-dark: #374151;
    --transition: all 0.3s ease-in-out;
    --card-radius: 16px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;
}

body {
    transition: var(--transition);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

body.light-theme {
    background-color: var(--bg-light);
    color: var(--text-light);
    --accent-color: var(--accent-light);
    --btn-bg: var(--btn-bg-light);
}

body.dark-theme {
    background-color: var(--bg-dark);
    color: var(--text-dark);
    --accent-color: var(--accent-dark);
    --btn-bg: var(--btn-bg-dark);
}

.container {
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    flex: 1;
}

header {
    padding: 0.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid;
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
}

.light-theme header {
    background-color: rgba(255, 255, 255, 0.8);
    border-color: var(--border-light);
}

.dark-theme header {
    background-color: rgba(31, 31, 31, 0.8);
    border-color: var(--border-dark);
}

.logo {
    display: flex;
    align-items: center;
    cursor: pointer;
}

.logo img {
    height: 50px; 
    display: none;
}

.light-theme .logo .logo-light {
    display: block;
}

.dark-theme .logo .logo-dark {
    display: block;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.menu-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.8rem;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: inherit;
}

.nav-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 1050;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}
.nav-overlay.active {
    opacity: 1;
    pointer-events: all;
}
.nav-menu {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    text-align: center;
}
.nav-link {
    color: white;
    text-decoration: none;
    font-size: 2rem;
    font-weight: 600;
    transition: transform 0.2s ease, color 0.2s ease;
    cursor: pointer;
}
.nav-link:hover {
    transform: scale(1.1);
    color: var(--accent-color);
}
.nav-link.active {
    color: var(--accent-color);
}

.settings-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: transform 0.5s ease;
    padding: 0;
    color: inherit;
}
.settings-btn svg {
  display: block;
}


.settings-btn:hover, .settings-btn:focus {
    transform: rotate(90deg);
}
.settings-btn:active {
    transform: rotate(180deg);
}

.page-section {
    display: none;
}
.page-section.active {
    display: block;
    animation: fadeIn 0.5s ease-in-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.main-clock {
    text-align: center;
    padding: 2rem;
    border-radius: var(--card-radius);
    margin-bottom: 2rem;
    transition: var(--transition);
    cursor: pointer; /* For fullscreen toggle */
}
.main-clock .date {
    transition: color 0.2s ease;
}

.light-theme .main-clock {
    background-color: var(--card-bg-light);
    box-shadow: var(--shadow-light);
}

.dark-theme .main-clock {
    background-color: var(--card-bg-dark);
    box-shadow: var(--shadow-dark);
}

.main-clock:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
}
.dark-theme .main-clock:hover {
    box-shadow: 0 12px 30px rgba(0,0,0,0.4);
}

.main-clock .time {
    font-size: clamp(3rem, 12vw, 6rem);
    font-weight: 700;
    letter-spacing: -2px;
    font-variant-numeric: tabular-nums; 
}

.main-clock .location {
    font-size: 1rem;
    opacity: 0.6;
    margin-top: 0.5rem;
}

.search-container {
    position: relative;
    max-width: 600px;
    margin: 0 auto 2rem auto;
}

.search-input {
    width: 100%;
    padding: 1rem 1.5rem;
    border-radius: 50px;
    border: 1px solid;
    font-size: 1rem;
    transition: var(--transition);
}

.light-theme .search-input {
    background-color: var(--card-bg-light);
    color: var(--text-light);
    border-color: var(--border-light);
}

.dark-theme .search-input {
    background-color: var(--card-bg-dark);
    color: var(--text-dark);
    border-color: var(--border-dark);
}

.search-input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
}

.search-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    width: 100%;
    max-height: 300px;
    overflow-y: auto;
    border-radius: 12px;
    z-index: 100;
    margin-top: 0.5rem;
    display: none;
}

.light-theme .search-dropdown {
    background-color: var(--card-bg-light);
    box-shadow: var(--shadow-light);
}

.dark-theme .search-dropdown {
    background-color: var(--card-bg-dark);
    box-shadow: var(--shadow-dark);
}

.search-dropdown.active {
    display: block;
}

.search-dropdown-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: background-color 0.2s ease;
}

.search-dropdown-item:hover {
    background-color: rgba(212, 175, 55, 0.1);
}

.search-dropdown-item .flag { font-size: 1.5rem; }
.search-dropdown-item .city-name { font-weight: 500; }
.search-dropdown-item .timezone { font-size: 0.8rem; opacity: 0.7; margin-left: auto; }

.clocks-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.clock-card {
    padding: 1.5rem;
    border-radius: var(--card-radius);
    transition: var(--transition);
    position: relative;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.clock-card:hover {
    transform: translateY(-5px);
}

.clock-card.card-day {
    background-color: var(--card-bg-light);
    color: var(--text-light);
    box-shadow: var(--shadow-light);
}
.clock-card.card-day:hover {
    box-shadow: 0 12px 30px rgba(0,0,0,0.15);
}

.clock-card.card-night {
    background-color: var(--card-bg-dark);
    color: var(--text-dark);
    box-shadow: var(--shadow-dark);
}
.clock-card.card-night:hover {
    box-shadow: 0 12px 30px rgba(0,0,0,0.4);
}


.clock-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.clock-card-title .flag { font-size: 1.5rem; margin-right: 0.5rem; }
.clock-card-title .city-name { font-size: 1.2rem; font-weight: 600; }

.remove-card-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    opacity: 0;
    transform: scale(0.5);
    transition: opacity 0.2s ease, transform 0.2s ease;
}
.card-day .remove-card-btn {
    background-color: #e74c3c;
    color: white;
}
.card-night .remove-card-btn {
    background-color: #c0392b;
    color: white;
}
.clock-card:hover .remove-card-btn {
    opacity: 1;
    transform: scale(1);
}

.clock-card .time { font-size: 2.2rem; font-weight: 500; }
.clock-card .date { font-size: 0.9rem; opacity: 0.8; }

.time-difference {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    display: inline-block;
    font-weight: 500;
    margin-top: 0.25rem;
    background-color: rgba(128, 128, 128, 0.1);
}

.card-night .time-difference {
     background-color: rgba(255, 255, 255, 0.1);
}

.day-night-indicator {
    position: absolute;
    top: 1rem;
    right: 1rem;
    font-size: 1.2rem;
}

.section {
     margin-bottom: 2rem;
}

.section-title {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid;
}
.light-theme .section-title { border-color: var(--border-light); }
.dark-theme .section-title { border-color: var(--border-dark); }

#popular-cities-container {
    background-color: #1a1a1a;
    color: #d1d5db;
    padding: 2rem;
    border-radius: var(--card-radius);
    text-align: center;
}
#city-cloud {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 0.5rem 1rem;
}
.city-item, .timezone-item {
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    transition: background-color 0.3s ease, color 0.3s ease;
    line-height: 1.5;
    display: inline-block;
}
.city-item:hover, .timezone-item:hover {
    background-color: #ffffff;
    color: #000000 !important;
}
.timezone-controls {
    margin-top: 2rem;
    text-align: center;
}
.timezone-controls .timezone-item {
    font-size: 0.875rem;
    color: #9ca3af;
}
.city-item.size-1 { font-size: 0.9rem; font-weight: 400; color: #9ca3af; }
.city-item.size-2 { font-size: 1rem; font-weight: 500; color: #d1d5db; }
.city-item.size-3 { font-size: 1.25rem; font-weight: 600; color: #e5e7eb; }
.city-item.size-4 { font-size: 1.5rem; font-weight: 700; color: #f9fafb; }
.city-item.size-5 { font-size: 1.875rem; font-weight: 800; color: #ffffff; }

textarea {
    width: 100%;
    min-height: 120px;
    padding: 1rem;
    border-radius: var(--card-radius);
    border: 1px solid;
    font-size: 1rem;
    resize: vertical;
    transition: var(--transition);
}
.light-theme textarea { background-color: var(--card-bg-light); color: var(--text-light); border-color: var(--border-light); }
.dark-theme textarea { background-color: var(--card-bg-dark); color: var(--text-dark); border-color: var(--border-dark); }
textarea:focus { outline: none; border-color: var(--accent-color); }

.calendar {
    border-radius: var(--card-radius);
    overflow: hidden;
    transition: var(--transition);
}
.light-theme .calendar { background-color: var(--card-bg-light); box-shadow: var(--shadow-light); }
.dark-theme .calendar { background-color: var(--card-bg-dark); box-shadow: var(--shadow-dark); }

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    background-color: rgba(0,0,0,0.1);
}
.dark-theme .calendar-header {
    background-color: rgba(255,255,255,0.05);
}


.calendar-title-text {
    font-weight: 600; font-size: 1.1rem;
    cursor: pointer;
    transition: opacity 0.2s;
    background: var(--btn-bg);
    color: inherit;
    padding: 0.5rem 1rem;
    border-radius: 8px;
}
.calendar-title-text:hover {
    opacity: 0.8;
}

.calendar-nav { display: flex; gap: 0.5rem; }
.calendar-nav-btn { background: none; border: none; color: inherit; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s ease; }
.calendar-nav-btn:hover { background-color: rgba(128, 128, 128, 0.1); }

.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); padding: 1rem; gap: 0.5rem; }
.calendar-day-header { text-align: center; font-weight: 600; font-size: 0.8rem; opacity: 0.7; }
.calendar-day { 
    text-align: center; padding: 0.5rem; cursor: pointer; border-radius: 50%; 
    width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; 
    margin: 0 auto; transition: background-color 0.2s ease;
    position: relative;
}
.calendar-day:hover { background-color: rgba(212, 175, 55, 0.1); }
.calendar-day.selected {
    box-shadow: 0 0 0 2px var(--accent-color);
}
.calendar-day.today { background-color: var(--accent-color); color: white; font-weight: 600; }
.calendar-day.other-month { opacity: 0.3; }
.calendar-day.has-note::after {
    content: '';
    position: absolute;
    bottom: 4px;
    left: 50%;
    transform: translateX(-50%);
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background-color: var(--accent-color);
}
.calendar-day.today.has-note::after {
    background-color: white;
}

/* --- Sound Player Styles --- */
.sounds-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    padding: 0;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}
.sound-btn {
    background: none;
    border: 2px solid;
    color: inherit;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 0.25rem;
    transition: var(--transition);
    font-size: 0.75rem;
    font-weight: 500;
    opacity: 0.7;
}
.light-theme .sound-btn {
    border-color: var(--border-light);
}
.dark-theme .sound-btn {
    border-color: var(--border-dark);
}
.sound-btn:hover {
    opacity: 1;
    border-color: var(--accent-color);
}
.sound-btn.active {
    background-color: #3b82f6; /* Blue background for active state */
    color: white;
    border-color: #3b82f6;
    opacity: 1;
}
.sound-btn img {
    width: 28px;
    height: 28px;
    pointer-events: none; /* Make sure clicks go to the button */
    transition: filter 0.3s ease-in-out;
}

/* In dark mode, make the icons white */
.dark-theme .sound-btn:not(.active) img {
    filter: invert(1);
}

/* When active, the icon should always be white, against the blue background */
.sound-btn.active img {
    filter: brightness(0) invert(1);
}

.action-buttons-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
}
.action-btn {
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 50px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-weight: 500;
    background-color: var(--btn-bg);
    color: inherit;
}
.light-theme .action-btn { color: #374151; }
.dark-theme .action-btn { color: #e5e7eb; }


.reset-btn {
    background-color: #22c55e;
}
.reset-btn:hover { background-color: #16a34a; }
.refresh-btn:hover {
    opacity: 0.8;
}
.refresh-btn:disabled {
    background-color: #95a5a6;
    cursor: not-allowed;
}
.all-notes-btn:hover {
    opacity: 0.8;
}


footer {
    padding: 2rem 1.5rem;
    background-color: white;
}

.light-theme .site-footer {
    background-color: #f9fafb;
    color: #4b5563;
}
.dark-theme .site-footer {
    background-color: var(--card-bg-dark);
    color: #9ca3af;
}

.site-footer {
    padding: 3rem 1.5rem;
}
.footer-container {
    max-width: 1200px;
    margin: 0 auto;
}
.footer-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid;
}
.light-theme .footer-top { border-color: var(--border-light); }
.dark-theme .footer-top { border-color: var(--border-dark); }

.footer-logo img {
    height: 65px;
    display: none;
}
.light-theme .footer-logo .logo-light {
    display: block;
}
.dark-theme .footer-logo .logo-dark {
    display: block;
}

.app-store-btn img {
    height: 40px;
}

.footer-links {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.footer-column ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.footer-column li {
    margin-bottom: 0.75rem;
}

.footer-column a {
    text-decoration: none;
    color: inherit;
    transition: color 0.2s;
}

.footer-column a:hover {
    color: var(--accent-color);
}

.footer-bottom {
    font-size: 0.875rem;
    opacity: 0.8;
}
.footer-bottom p {
    margin-bottom: 0.5rem;
}
.footer-bottom a {
    color: var(--accent-color);
    text-decoration: none;
}
.footer-bottom a:hover {
    text-decoration: underline;
}

.quote-wrapper {
    padding: 2rem 1.5rem;
    background-color: #ffffff;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 140px;
}

.quote-container {
    text-align: center;
    max-width: 800px;
    margin: 0 auto;
}
.quote {
    font-family: 'Roboto Mono', monospace;
    font-style: italic;
    font-weight: 700;
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    color: #333;
}

.quote-author {
    font-family: 'Inter', sans-serif;
    font-size: 1rem;
    color: #555;
}


.quote-container .cursor {
    display: inline-block;
    background-color: #333;
    margin-left: 2px;
    width: 3px;
    height: 1.2rem;
    animation: blink 1s infinite;
}

.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(5px);
    display: flex; justify-content: center; align-items: center;
    z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
}
.modal-overlay.active { opacity: 1; pointer-events: all; }

.modal-content {
    width: 90%; max-width: 500px; border-radius: var(--card-radius);
    padding: 2rem; position: relative; transition: transform 0.3s ease;
    transform: scale(0.95);
    max-height: 80vh; 
    display: flex; 
    flex-direction: column;
}
.modal-overlay.active .modal-content { transform: scale(1); }
.light-theme .modal-content { background-color: var(--card-bg-light); }
.dark-theme .modal-content { background-color: var(--card-bg-dark); }

.modal-header {
    flex-shrink: 0;
}

.modal-body {
    overflow-y: auto; 
    flex-grow: 1;
    margin-top: 1rem;
}


.close-modal-btn {
    position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem;
    cursor: pointer; width: 30px; height: 30px; display: flex;
    align-items: center; justify-content: center; border-radius: 50%;
    transition: var(--transition);
    background: none; border: none;
    color: inherit;
}
.close-modal-btn:hover { background-color: rgba(128, 128, 128, 0.1); transform: rotate(90deg); }

#allNotesContent .note-entry {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid;
}
.light-theme #allNotesContent .note-entry { border-color: var(--border-light); }
.dark-theme #allNotesContent .note-entry { border-color: var(--border-dark); }
#allNotesContent .note-entry:last-child {
    border-bottom: none;
    margin-bottom: 0;
}
#allNotesContent .note-date {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--accent-color);
}
#allNotesContent .note-text {
    white-space: pre-wrap;
    word-wrap: break-word;
}

#datePickerModal .modal-content {
    max-width: 400px;
    background-color: #2c3e50;
    color: #ecf0f1;
}
.date-picker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}
.date-picker-year-selector {
    display: flex;
    align-items: center;
    gap: 1rem;
}
.year-nav-btn {
    background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;
}
.year-input {
    font-size: 1.5rem; font-weight: 600;
    background: none;
    border: none;
    border-bottom: 2px solid rgba(255,255,255,0.5);
    color: white;
    width: 70px;
    text-align: center;
    padding: 0.25rem;
}
.year-input:focus {
    outline: none;
    border-bottom-color: var(--accent-color);
}
.year-input::-webkit-outer-spin-button,
.year-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.year-input[type=number] {
    -moz-appearance: textfield;
}

.date-picker-months-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
}
.month-btn {
    background: none;
    border: 2px solid transparent;
    color: #ecf0f1;
    padding: 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s, border-color 0.2s;
    font-size: 1rem;
    font-weight: 500;
}
.month-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
.month-btn.active {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
}

.fullscreen-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: black;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
    overflow: hidden;
    cursor: pointer;
}
.fullscreen-overlay.active { opacity: 1; pointer-events: all; }

.fullscreen-overlay .time,
.fullscreen-overlay .date {
    font-variant-numeric: tabular-nums;
    pointer-events: none;
    color: #fff;
    animation: moving-glow 4s ease-in-out infinite;
}

.fullscreen-overlay .time { 
    font-size: clamp(4rem, 20vw, 12rem); 
    font-weight: 700;
}
.fullscreen-overlay .date { 
    font-size: clamp(1.5rem, 6vw, 3rem); 
    opacity: 0.8;
}

@keyframes moving-glow {
    0% { text-shadow: 0 0 10px rgba(255,255,255,0.8), 0 0 20px rgba(255,255,255,0.6); }
    50% { text-shadow: 0 0 20px rgba(255,255,255,1), 0 0 30px rgba(255,255,255,0.8), 0 0 40px rgba(255,255,255,0.5); }
    100% { text-shadow: 0 0 10px rgba(255,255,255,0.8), 0 0 20px rgba(255,255,255,0.6); }
}

/* --- Focus Mode Styles --- */
.video-background-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; 
    opacity: 0;
    transition: opacity 0.5s ease;
    overflow: hidden;
}

.video-background-container iframe {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100vw;
    height: 56.25vw; /* 16:9 aspect ratio */
    min-height: 100vh;
    min-width: 177.77vh; /* 16:9 aspect ratio */
    transform: translate(-50%, -50%);
    pointer-events: none; 
}

.fullscreen-overlay.focus-active .video-background-container {
    opacity: 0.3; /* Make it a subtle background */
}

.fullscreen-overlay.focus-active .time,
.fullscreen-overlay.focus-active .date {
    animation: none; /* Turn off moving glow in focus mode to keep gradient */
    background: linear-gradient(45deg, var(--accent-dark), #fff, var(--accent-dark));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    background-size: 200% 200%;
    animation: gradient-animation 5s ease-in-out infinite;
}

@keyframes gradient-animation {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

.settings-group { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid; }
.light-theme .settings-group { border-color: var(--border-light); }
.dark-theme .settings-group { border-color: var(--border-dark); }
.settings-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

.settings-group h3 { margin-bottom: 1rem; font-size: 1.2rem; color: var(--accent-color); }
.setting-row { margin-top: 1rem; display: flex; align-items: center; justify-content: space-between; }

.toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
.slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--accent-color); }
input:checked + .slider:before { transform: translateX(22px); }

.language-select {
    width: 100%; padding: 0.75rem; border-radius: 8px;
    border: 1px solid; font-size: 1rem;
}
.light-theme .language-select { background-color: var(--card-bg-light); color: var(--text-light); border-color: var(--border-light); }
.dark-theme .language-select { background-color: var(--card-bg-dark); color: var(--text-dark); border-color: var(--border-dark); }

.utility-container {
    max-width: 600px;
    margin: 2rem auto;
    padding: 2rem;
    border-radius: var(--card-radius);
}
.light-theme .utility-container {
    background-color: var(--card-bg-light);
    box-shadow: var(--shadow-light);
}
.dark-theme .utility-container {
    background-color: var(--card-bg-dark);
    box-shadow: var(--shadow-dark);
}

.utility-display {
    font-family: 'Roboto Mono', monospace;
    font-size: clamp(3rem, 12vw, 5rem);
    text-align: center;
    font-weight: 700;
    margin-bottom: 1.5rem;
    font-variant-numeric: tabular-nums;
}
.utility-display .milliseconds {
    font-size: 0.5em;
    color: var(--accent-color);
}

.utility-controls {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}
.utility-btn {
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    transition: var(--transition);
    min-width: 100px; 
    background-color: var(--btn-bg);
    color: inherit;
}
.light-theme .utility-btn { color: #374151; }
.dark-theme .utility-btn { color: #e5e7eb; }

.utility-btn.start-btn { background-color: #22c55e; color: white; }
.utility-btn.start-btn:hover { background-color: #16a34a; }
.utility-btn.stop-btn { background-color: #ef4444; color: white; }
.utility-btn.stop-btn:hover { background-color: #dc2626; }
.utility-btn:hover {
    opacity: 0.8;
}

.laps-list, .alarms-list {
    list-style: none;
    padding: 0;
    max-height: 3000px;
    overflow-y: auto;
}
.lap-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid;
    font-family: 'Roboto Mono', monospace;
}
.light-theme .lap-item { border-color: var(--border-light); }
.dark-theme .lap-item { border-color: var(--border-dark); }
.lap-item:last-child { border-bottom: none; }
.lap-number { font-weight: bold; }

.timer-inputs {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
}
.timer-input-group {
    display: flex;
    flex-direction: column;
    align-items: center;
}
.timer-input-group label {
    font-size: 0.8rem;
    margin-bottom: 0.25rem;
    opacity: 0.7;
}
.timer-input {
    width: 80px;
    padding: 0.5rem;
    font-size: 1.5rem;
    text-align: center;
    border-radius: 8px;
    border: 1px solid;
}
.light-theme .timer-input { background-color: #f0f4f8; border-color: var(--border-light); }
.dark-theme .timer-input { background-color: #1a2639; border-color: var(--border-dark); color: var(--text-dark); }

.add-alarm-form {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}
.add-alarm-form input {
    flex-grow: 1;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid;
}
.light-theme .add-alarm-form input { background-color: #f0f4f8; border-color: var(--border-light); }
.dark-theme .add-alarm-form input { background-color: #1a2639; border-color: var(--border-dark); color: var(--text-dark); }
.add-alarm-btn {
    background-color: var(--accent-color);
    color: white;
}

.alarm-item {
    padding: 0;
    border: none;
    border-bottom: 1px solid;
}
.light-theme .alarm-item { border-color: var(--border-light); }
.dark-theme .alarm-item { border-color: var(--border-dark); }
.alarm-item:last-child {
    border-bottom: none;
}

.alarm-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    transition: var(--transition);
}
.light-theme .alarm-card.disabled { background-color: transparent; }
.dark-theme .alarm-card.disabled { background-color: transparent; }

.alarm-card-details {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex-grow: 1;
}
.alarm-card-time {
    font-family: 'Roboto Mono', monospace;
    font-size: 2rem;
    font-weight: 500;
}
.alarm-card-label {
    font-size: 1rem;
    opacity: 0.8;
}
.alarm-countdown {
    font-family: 'Roboto Mono', monospace;
    font-size: 0.85rem;
    color: var(--accent-color);
    margin-top: 0.5rem;
    min-height: 1.2em; 
}
.alarm-card-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-shrink: 0;
}
.delete-alarm-btn {
    background: none;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 1.5rem;
    transition: transform 0.2s ease;
}
.delete-alarm-btn:hover {
    transform: scale(1.1);
}
.alarm-card.disabled {
    opacity: 0.6;
}
.alarm-card.disabled .alarm-card-time,
.alarm-card.disabled .alarm-card-label {
    text-decoration: line-through;
}
    </style>
</head>
<body>
    <header>
        <div class="logo" id="logoLink">
            <img src="LOGOBlack H.png" alt="AIRCLOCK Logo" class="logo-light">
            <img src="LOGOWhite H.png" alt="AIRCLOCK Logo" class="logo-dark">
        </div>
        <div class="header-right">
            <button class="menu-btn" id="menuBtn">☰</button>
            <button class="settings-btn" id="settingsBtn">
              <svg xmlns="http://www.w3.org/2000/svg" 
                   width="24" height="24" viewBox="0 0 24 24" 
                   fill="none" stroke="currentColor" 
                   stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82 2 2 0 1 1-2.83 2.83 1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51A2 2 0 1 1 9.9 21 a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33 2 2 0 1 1-2.83-2.83 1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1A2 2 0 1 1 3 9.9 a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82 2 2 0 1 1 2.83-2.83 1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1-1.51A2 2 0 1 1 14.1 3 a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33 2 2 0 1 1 2.83 2.83 1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0 1.51 1A2 2 0 1 1 21 14.1 a1.65 1.65 0 0 0-1.51 1z"></path>
              </svg>
            </button>
        </div>
    </header>

    <div class="nav-overlay" id="navOverlay">
        <nav class="nav-menu">
            <a class="nav-link" data-page="time">Time</a>
            <a class="nav-link" data-page="stopwatch">Stopwatch</a>
            <a class="nav-link" data-page="timer">Timer</a>
            <a class="nav-link" data-page="alarm">Alarm</a>
        </nav>
    </div>

    <div class="container">
        <div id="page-time" class="page-section active">
            <div class="main-clock" id="mainClockContainer">
                <div class="time" id="mainTime">--:--:--</div>
                <div class="date" id="mainDate">Loading...</div>
                <div class="location" id="mainLocation"></div>
                <div class="sounds-container" id="soundsContainer">
                    <button class="sound-btn" data-video-id="q76bMs-NwRk">
                        <img src="rain.svg" alt="Rain icon">
                        <span>Rain</span>
                    </button>
                    <button class="sound-btn" data-video-id="xNN7iTA57jM">
                        <img src="Forest.svg" alt="Forest icon">
                        <span>Forest</span>
                    </button>
                    <button class="sound-btn" data-video-id="BqAzRJmivqw">
                        <img src="OWL.svg" alt="Owl icon">
                        <span>Owl</span>
                    </button>
                    <button class="sound-btn" data-video-id="ztVV54sPOns">
                        <img src="Focus.svg" alt="Focus icon">
                        <span>Focus</span>
                    </button>
                </div>
            </div>

            <div class="search-container" id="searchContainer">
                <input type="text" class="search-input" id="citySearchInput" placeholder="Search for a city or country...">
                <div class="search-dropdown" id="searchDropdown"></div>
            </div>

            <div class="clocks-grid" id="clocksGrid"></div>

            <div class="section" id="popular-cities-section">
                <h2 class="section-title">Most popular timezones and cities</h2>
                <div id="popular-cities-container">
                    <div id="city-cloud"></div>
                    <div class="timezone-controls">
                        <div class="flex justify-center items-center space-x-4">
                            <span class="timezone-item">UTC</span>
                            <span class="timezone-item">GMT</span>
                            <span class="timezone-item">CET</span>
                        </div>
                        <div class="flex flex-wrap justify-center items-center space-x-4 mt-4">
                            <span class="timezone-item">Pacific Time</span>
                            <span class="timezone-item">Mountain Time</span>
                            <span class="timezone-item">Central Time</span>
                            <span class="timezone-item">Eastern Time</span>
                            <span class="timezone-item">China Standard Time</span>
                            <span class="timezone-item">India Standard Time</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title" id="calendarSectionTitle">Calendar</h2>
                <div class="calendar">
                    <div class="calendar-header">
                        <span class="calendar-title-text" id="calendarTitleText"></span>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" id="prevMonthBtn">◀</button>
                            <button class="calendar-nav-btn" id="nextMonthBtn">▶</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title" id="notesTitle">Notes</h2>
                <textarea id="notesArea" placeholder="Write something..."></textarea>
            </div>
            
            <div class="section action-buttons-container">
                <button class="action-btn" id="refreshCardsBtn">Refresh Cards</button>
                <button class="action-btn" id="showAllNotesBtn">Show All Notes</button>
                <button class="action-btn reset-btn" id="resetBtn">Reset All Data</button>
            </div>
        </div>

        <div id="page-stopwatch" class="page-section">
            <div class="utility-container">
                <h2 class="section-title">Stopwatch</h2>
                <div class="utility-display" id="stopwatchDisplay">00:00:00<span class="milliseconds">.00</span></div>
                <div class="utility-controls">
                    <button class="utility-btn start-btn" id="stopwatchToggleBtn">Start</button>
                    <button class="utility-btn" id="stopwatchLapBtn">Lap</button>
                    <button class="utility-btn" id="stopwatchResetBtn">Reset</button>
                </div>
                <ul class="laps-list" id="lapsList"></ul>
            </div>
        </div>

        <div id="page-timer" class="page-section">
            <div class="utility-container">
                <h2 class="section-title">Timer</h2>
                <div class="utility-display" id="timerDisplay">00:00:00</div>
                <div class="timer-inputs" id="timerInputs">
                    <div class="timer-input-group">
                        <label for="timerHours">Hours</label>
                        <input type="number" id="timerHours" class="timer-input" min="0" max="99" value="0">
                    </div>
                    <div class="timer-input-group">
                        <label for="timerMinutes">Minutes</label>
                        <input type="number" id="timerMinutes" class="timer-input" min="0" max="59" value="10">
                    </div>
                    <div class="timer-input-group">
                        <label for="timerSeconds">Seconds</label>
                        <input type="number" id="timerSeconds" class="timer-input" min="0" max="59" value="0">
                    </div>
                </div>
                <div class="utility-controls">
                    <button class="utility-btn start-btn" id="timerToggleBtn">Start</button>
                    <button class="utility-btn" id="timerResetBtn">Reset</button>
                </div>
            </div>
        </div>

        <div id="page-alarm" class="page-section">
            <div class="utility-container">
                <h2 class="section-title">Alarm</h2>
                <div class="add-alarm-form">
                    <input type="time" id="alarmTimeInput">
                    <input type="text" id="alarmLabelInput" placeholder="Alarm label">
                    <button class="utility-btn add-alarm-btn" id="addAlarmBtn">Add</button>
                </div>
                <ul class="alarms-list" id="alarmsList"></ul>
            </div>
        </div>
    </div>

    <div class="quote-wrapper">
        <div class="quote-container" id="quoteContainer">
            <p class="quote"><span id="quoteText"></span><span class="cursor" style="display: none;">&nbsp;</span></p>
            <p class="quote-author"><span id="quoteAuthor"></span></p>
        </div>
    </div>
     <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-top">
                <div class="footer-logo">
                    <img src="LOGOBlack.png" alt="AIRCLOCK Logo" class="logo-light">
                    <img src="LOGOWhite.png" alt="AIRCLOCK Logo" class="logo-dark">
                </div>
                <a href="#" class="app-store-btn">
                    <img src="https://web.archive.org/web/20240127134319im_/https://www.time.is/assets/img/appstore-nonretina.png" alt="Download on the App Store">
                </a>
            </div>
            <div class="footer-links">
                <div class="footer-column">
                    <ul>
                        <li><a href="#">Exact time now</a></li>
                        <li><a href="#">Time here&there</a></li>
                        <li><a href="#">Your time zone</a></li>
                        <li><a href="#">Time zones</a></li>
                        <li><a href="#">Daylight Saving Time</a></li>
                        <li><a href="#">Clock</a></li>
                        <li><a href="#">Countdown</a></li>
                        <li><a href="#">Calendar</a></li>
                        <li><a href="#">Compact calendar</a></li>
                        <li><a href="#">Week number</a></li>
                        <li><a href="#">Sound</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <ul>
                        <li><a href="#">Apps</a></li>
                        <li><a href="#">Widgets</a></li>
                        <li><a href="#">Time zone news</a></li>
                        <li><a href="#">Newsletter</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <ul>
                        <li><a href="#">UTC</a></li>
                        <li><a href="#">Unix clock</a></li>
                        <li><a href="#">Unix time converter</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <ul>
                        <li><a href="#">Customize</a></li>
                        <li><a href="#">Airclock Ad-free</a></li>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">How to use Airclock</a></li>
                        <li><a href="#">About</a></li>
                        <li><a href="#">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <ul>
                        <li><a href="#">Advertise</a></li>
                        <li><a href="#">Terms of use</a></li>
                        <li><a href="#">Privacy policy</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Airclock displays exact, official atomic clock time for any time zone (more than 7 million locations) in 58 languages.</p>
                <p>
                    <a href="#">What time is it?</a> | <a href="#">¿Qué hora es?</a> | <a href="#">Quelle heure est-il ?</a> | <a href="#">Который час?</a> | <a href="#">Que horas são?</a> | <a href="#">Jam berapa?</a> | <a href="#">Wieviel Uhr ist es?</a> | <a href="#">» more languages</a>
                </p>
            </div>
        </div>
    </footer>

    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <div class="video-background-container" id="focusVideoContainer">
            <iframe id="focusVideoPlayer" 
                    src="" frameborder="0" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
            </iframe>
        </div>
        <div class="time" id="fullscreenTime"></div>
        <div class="date" id="fullscreenDate"></div>
    </div>

    <div class="modal-overlay" id="datePickerModal">
        <div class="modal-content">
            <div class="date-picker-header">
                <div class="date-picker-year-selector">
                    <button class="year-nav-btn" id="prevYearBtn">◀</button>
                    <input type="number" class="year-input" id="pickerYearInput">
                    <button class="year-nav-btn" id="nextYearBtn">▶</button>
                </div>
                <button class="close-modal-btn" id="closeDatePickerBtn">✕</button>
            </div>
            <div class="date-picker-months-grid" id="datePickerMonthsGrid">
                </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="allNotesModal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-modal-btn" id="closeAllNotesBtn">✕</button>
                <h2 id="allNotesTitle">All Notes</h2>
            </div>
            <div class="modal-body" id="allNotesContent">
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeSettingsBtn">✕</button>
            <h2 id="settingsModalTitle">Settings</h2>
            
            <div class="settings-group">
                <h3 id="themeSettingsTitle">Theme</h3>
                <div class="setting-row">
                    <span id="autoThemeLabel">Auto Theme</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoThemeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-row">
                    <span id="darkThemeLabel">Dark Mode</span>
                    <label class="toggle-switch" id="manualThemeToggleContainer">
                        <input type="checkbox" id="manualThemeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-group">
                <h3 id="formatSettingsTitle">Format</h3>
                <div class="setting-row">
                    <span id="hourFormatLabel">24-Hour Format</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="hourFormatToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <h3 id="languageSettingsTitle">Language</h3>
                <select id="languageSelect" class="language-select">
                    </select>
            </div>
        </div>
    </div>

    <div id="player-container" style="position: absolute; width: 1px; height: 1px; opacity: 0;">
        <iframe id="youtube-player" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
    </div>

    <script>
        // --- 1. CONFIGURATION & STATE MANAGEMENT ---
const dom = {
    body: document.body,
    logoLink: document.getElementById('logoLink'),
    mainTime: document.getElementById('mainTime'),
    mainDate: document.getElementById('mainDate'),
    mainLocation: document.getElementById('mainLocation'),
    mainClockContainer: document.getElementById('mainClockContainer'),
    searchContainer: document.getElementById('searchContainer'),
    citySearchInput: document.getElementById('citySearchInput'),
    searchDropdown: document.getElementById('searchDropdown'),
    clocksGrid: document.getElementById('clocksGrid'),
    notesArea: document.getElementById('notesArea'),
    resetBtn: document.getElementById('resetBtn'),
    refreshCardsBtn: document.getElementById('refreshCardsBtn'),
    showAllNotesBtn: document.getElementById('showAllNotesBtn'),
    allNotesModal: document.getElementById('allNotesModal'),
    closeAllNotesBtn: document.getElementById('closeAllNotesBtn'),
    allNotesContent: document.getElementById('allNotesContent'),
    menuBtn: document.getElementById('menuBtn'),
    navOverlay: document.getElementById('navOverlay'),
    navLinks: document.querySelectorAll('.nav-link'),
    settingsBtn: document.getElementById('settingsBtn'),
    settingsModal: document.getElementById('settingsModal'),
    closeSettingsBtn: document.getElementById('closeSettingsBtn'),
    autoThemeToggle: document.getElementById('autoThemeToggle'),
    manualThemeToggle: document.getElementById('manualThemeToggle'),
    manualThemeToggleContainer: document.getElementById('manualThemeToggleContainer'),
    hourFormatToggle: document.getElementById('hourFormatToggle'),
    languageSelect: document.getElementById('languageSelect'),
    calendarTitleText: document.getElementById('calendarTitleText'),
    calendarGrid: document.getElementById('calendarGrid'),
    prevMonthBtn: document.getElementById('prevMonthBtn'),
    nextMonthBtn: document.getElementById('nextMonthBtn'),
    datePickerModal: document.getElementById('datePickerModal'),
    closeDatePickerBtn: document.getElementById('closeDatePickerBtn'),
    pickerYearInput: document.getElementById('pickerYearInput'),
    prevYearBtn: document.getElementById('prevYearBtn'),
    nextYearBtn: document.getElementById('nextYearBtn'),
    datePickerMonthsGrid: document.getElementById('datePickerMonthsGrid'),
    fullscreenOverlay: document.getElementById('fullscreenOverlay'),
    fullscreenTime: document.getElementById('fullscreenTime'),
    fullscreenDate: document.getElementById('fullscreenDate'),
    focusVideoContainer: document.getElementById('focusVideoContainer'),
    focusVideoPlayer: document.getElementById('focusVideoPlayer'),
    popularCitiesContainer: document.getElementById('popular-cities-container'),
    quoteContainer: document.getElementById('quoteContainer'),
    quoteText: document.getElementById('quoteText'),
    quoteAuthor: document.getElementById('quoteAuthor'),
    stopwatchDisplay: document.getElementById('stopwatchDisplay'),
    stopwatchToggleBtn: document.getElementById('stopwatchToggleBtn'),
    stopwatchLapBtn: document.getElementById('stopwatchLapBtn'),
    stopwatchResetBtn: document.getElementById('stopwatchResetBtn'),
    lapsList: document.getElementById('lapsList'),
    timerDisplay: document.getElementById('timerDisplay'),
    timerInputsContainer: document.getElementById('timerInputs'),
    timerHoursInput: document.getElementById('timerHours'),
    timerMinutesInput: document.getElementById('timerMinutes'),
    timerSecondsInput: document.getElementById('timerSeconds'),
    timerToggleBtn: document.getElementById('timerToggleBtn'),
    timerResetBtn: document.getElementById('timerResetBtn'),
    alarmTimeInput: document.getElementById('alarmTimeInput'),
    alarmLabelInput: document.getElementById('alarmLabelInput'),
    addAlarmBtn: document.getElementById('addAlarmBtn'),
    alarmsList: document.getElementById('alarmsList'),
    uiText: {
        notesTitle: document.getElementById('notesTitle'),
        calendarSectionTitle: document.getElementById('calendarSectionTitle'),
        settingsModalTitle: document.getElementById('settingsModalTitle'),
        themeSettingsTitle: document.getElementById('themeSettingsTitle'),
        formatSettingsTitle: document.getElementById('formatSettingsTitle'),
        languageSettingsTitle: document.getElementById('languageSettingsTitle'),
        autoThemeLabel: document.getElementById('autoThemeLabel'),
        darkThemeLabel: document.getElementById('darkThemeLabel'),
        hourFormatLabel: document.getElementById('hourFormatLabel'),
        allNotesTitle: document.getElementById('allNotesTitle'),
        showAllNotesBtn: document.getElementById('showAllNotesBtn'),
    }
};

let state = {
    mainClock: null, 
    pinnedClocks: [],
    settings: {
        autoTheme: true,
        manualThemeDark: false,
        is24Hour: true,
        language: 'en'
    },
    currentCalendarDate: new Date(),
    selectedDate: new Date(), 
    notes: {}, 
    stopwatch: {
        startTime: 0,
        elapsedTime: 0,
        intervalId: null,
        laps: []
    },
    timer: {
        totalSeconds: 0,
        remainingSeconds: 0,
        intervalId: null 
    },
    alarms: [],
    alarmCheckInterval: null
};

let clockUpdateInterval = null; 
const API_BASE_URL = 'https://worldtimeapi.org/api';

const quotes = [
    { text: "Time is the richest gift, yet the poorest kept.", author: "Elena Marlowe" },
    { text: "We measure life in years but waste it in moments.", author: "Victor Hale" },
    { text: "Time heals all wounds, except the ones we refuse to let go of.", author: "Sophia Durant" },
    { text: "The clock never stops, but we often pause for nothing.", author: "Marcus Linton" },
    { text: "Time is silent, but it speaks the loudest truth.", author: "Isabel Moreau" },
    { text: "We chase time as if it runs, yet it patiently waits for no one.", author: "Julian Hart" },
    { text: "The value of time is realized only when it has slipped away.", author: "Clara Voss" },
    { text: "We spend time like coins, forgetting there’s no way to earn them back.", author: "Adrian Cole" },
    { text: "Time is a teacher that never asks for permission to give lessons.", author: "Nora Bennett" },
    { text: "The cruelest thief is time, for it steals without warning.", author: "Samuel Rhodes" },
    { text: "We wish for more hours, yet squander the ones we have.", author: "Ivy Lorenz" },
    { text: "Time rewards the disciplined and punishes the careless.", author: "Damian Cross" },
    { text: "Every second wasted is a debt you can never repay.", author: "Lydia Carver" },
    { text: "We borrow time from tomorrow but rarely repay it today.", author: "Edwin Frost" },
    { text: "Time is a canvas—some paint masterpieces, others leave it blank.", author: "Aria Sinclair" },
    { text: "We live as if time is infinite, though each breath proves otherwise.", author: "Noah Whitfield" },
    { text: "The costliest luxury is the moment you let slip.", author: "Fiona Gray" },
    { text: "Time is both our servant and our master.", author: "Leonard Ashcroft" },
    { text: "We count hours but forget to make hours count.", author: "Selene Ward" },
    { text: "Time is the only currency that grows more precious as it runs out.", author: "Gabriel Stone" }
];


const cityData = [
    { name: "New York", country: "USA", timezone: "America/New_York", flag: "🇺🇸" },
    { name: "London", country: "United Kingdom", timezone: "Europe/London", flag: "🇬🇧" },
    { name: "Tokyo", country: "Japan", timezone: "Asia/Tokyo", flag: "🇯🇵" },
    { name: "Paris", country: "France", timezone: "Europe/Paris", flag: "🇫🇷" },
    { name: "Sydney", country: "Australia", timezone: "Australia/Sydney", flag: "🇦🇺" },
    { name: "Dhaka", country: "Bangladesh", timezone: "Asia/Dhaka", flag: "🇧🇩" },
    { name: "Berlin", country: "Germany", timezone: "Europe/Berlin", flag: "🇩🇪" },
    { name: "Los Angeles", country: "USA", timezone: "America/Los_Angeles", flag: "🇺🇸" },
    { name: "Chicago", country: "USA", timezone: "America/Chicago", flag: "🇺🇸" },
    { name: "Toronto", country: "Canada", timezone: "America/Toronto", flag: "🇨🇦" },
    { name: "Sao Paulo", country: "Brazil", timezone: "America/Sao_Paulo", flag: "🇧🇷" },
    { name: "Mexico City", country: "Mexico", timezone: "America/Mexico_City", flag: "🇲🇽" },
    { name: "Buenos Aires", country: "Argentina", timezone: "America/Argentina/Buenos_Aires", flag: "🇦🇷" },
    { name: "Lagos", country: "Nigeria", timezone: "Africa/Lagos", flag: "🇳🇬" },
    { name: "Cairo", country: "Egypt", timezone: "Africa/Cairo", flag: "🇪🇬" },
    { name: "Johannesburg", country: "South Africa", timezone: "Africa/Johannesburg", flag: "🇿🇦" },
    { name: "Nairobi", country: "Kenya", timezone: "Africa/Nairobi", flag: "🇰🇪" },
    { name: "Moscow", country: "Russia", timezone: "Europe/Moscow", flag: "🇷🇺" },
    { name: "Madrid", country: "Spain", timezone: "Europe/Madrid", flag: "🇪🇸" },
    { name: "Rome", country: "Italy", timezone: "Europe/Rome", flag: "🇮🇹" },
    { name: "Amsterdam", country: "Netherlands", timezone: "Europe/Amsterdam", flag: "🇳🇱" },
    { name: "Stockholm", country: "Sweden", timezone: "Europe/Stockholm", flag: "🇸🇪" },
    { name: "Istanbul", country: "Turkey", timezone: "Europe/Istanbul", flag: "🇹🇷" },
    { name: "Dubai", country: "UAE", timezone: "Asia/Dubai", flag: "🇦🇪" },
    { name: "Abu Dhabi", country: "UAE", timezone: "Asia/Dubai", flag: "🇦🇪" },
    { name: "Mumbai", country: "India", timezone: "Asia/Kolkata", flag: "🇮🇳" },
    { name: "Delhi", country: "India", timezone: "Asia/Kolkata", flag: "🇮🇳" },
    { name: "Shanghai", country: "China", timezone: "Asia/Shanghai", flag: "🇨🇳" },
    { name: "Beijing", country: "China", timezone: "Asia/Shanghai", flag: "🇨🇳" },
    { name: "Singapore", country: "Singapore", timezone: "Asia/Singapore", flag: "🇸🇬" },
    { name: "Seoul", country: "South Korea", timezone: "Asia/Seoul", flag: "🇰🇷" },
    { name: "Bangkok", country: "Thailand", timezone: "Asia/Bangkok", flag: "🇹🇭" },
    { name: "Jakarta", country: "Indonesia", timezone: "Asia/Jakarta", flag: "🇮🇩" },
    { name: "Kuala Lumpur", country: "Malaysia", timezone: "Asia/Kuala_Lumpur", flag: "🇲🇾" },
    { name: "Ho Chi Minh City", country: "Vietnam", timezone: "Asia/Ho_Chi_Minh", flag: "🇻🇳" },
    { name: "Manila", country: "Philippines", timezone: "Asia/Manila", flag: "🇵🇭" },
    { name: "Auckland", country: "New Zealand", timezone: "Pacific/Auckland", flag: "🇳🇿" },
    { name: "Honolulu", country: "USA", timezone: "Pacific/Honolulu", flag: "🇺🇸" },
    { name: "Ankara", country: "Turkey", timezone: "Europe/Istanbul", flag: "🇹🇷" },
    { name: "Riyadh", country: "Saudi Arabia", timezone: "Asia/Riyadh", flag: "🇸🇦" },
    { name: "Tehran", country: "Iran", timezone: "Asia/Tehran", flag: "🇮🇷" },
    { name: "Baghdad", country: "Iraq", timezone: "Asia/Baghdad", flag: "🇮🇶" },
    { name: "Lima", country: "Peru", timezone: "America/Lima", flag: "🇵🇪" },
    { name: "Bogota", country: "Colombia", timezone: "America/Bogota", flag: "🇨🇴" },
    { name: "Santiago", country: "Chile", timezone: "America/Santiago", flag: "🇨🇱" },
    { name: "Caracas", country: "Venezuela", timezone: "America/Caracas", flag: "🇻🇪" },
    { name: "Helsinki", country: "Finland", timezone: "Europe/Helsinki", flag: "🇫🇮" },
    { name: "Oslo", country: "Norway", timezone: "Europe/Oslo", flag: "🇳🇴" },
    { name: "Copenhagen", country: "Denmark", timezone: "Europe/Copenhagen", flag: "🇩🇰" },
    { name: "Dublin", country: "Ireland", timezone: "Europe/Dublin", flag: "🇮🇪" },
    { name: "Lisbon", country: "Portugal", timezone: "Europe/Lisbon", flag: "🇵🇹" },
    { name: "Prague", country: "Czech Republic", timezone: "Europe/Prague", flag: "🇨🇿" },
    { name: "Warsaw", country: "Poland", timezone: "Europe/Warsaw", flag: "🇵🇱" },
    { name: "Vienna", country: "Austria", timezone: "Europe/Vienna", flag: "🇦🇹" },
    { name: "Budapest", country: "Hungary", timezone: "Europe/Budapest", flag: "🇭🇺" },
    { name: "Athens", country: "Greece", timezone: "Europe/Athens", flag: "🇬🇷" },
    { name: "Addis Ababa", country: "Ethiopia", timezone: "Africa/Addis_Ababa", flag: "🇪🇹" },
    { name: "Karachi", country: "Pakistan", timezone: "Asia/Karachi", flag: "🇵🇰" },
    { name: "Taipei", country: "Taiwan", timezone: "Asia/Taipei", flag: "🇹🇼" }
];

const popularCities = [
    { name: "Abu Dhabi", size: 2, timezone: "Asia/Dubai" }, { name: "Addis Ababa", size: 1, timezone: "Africa/Addis_Ababa" }, { name: "Amsterdam", size: 3, timezone: "Europe/Amsterdam" },
    { name: "Beijing", size: 5, timezone: "Asia/Shanghai" }, { name: "Berlin", size: 3, timezone: "Europe/Berlin" },
    { name: "Buenos Aires", size: 4, timezone: "America/Argentina/Buenos_Aires" }, { name: "Cairo", size: 3, timezone: "Africa/Cairo" }, { name: "Chicago", size: 4, timezone: "America/Chicago" }, { name: "Delhi", size: 5, timezone: "Asia/Kolkata" }, { name: "Dhaka", size: 4, timezone: "Asia/Dhaka" },
    { name: "Dubai", size: 4, timezone: "Asia/Dubai" }, { name: "Hong Kong", size: 4, timezone: "Asia/Hong_Kong" }, { name: "Istanbul", size: 5, timezone: "Europe/Istanbul" }, { name: "Jakarta", size: 3, timezone: "Asia/Jakarta" },
    { name: "Karachi", size: 5, timezone: "Asia/Karachi" }, { name: "Lagos", size: 4, timezone: "Africa/Lagos" }, { name: "London", size: 5, timezone: "Europe/London" }, { name: "Los Angeles", size: 5, timezone: "America/Los_Angeles" },
    { name: "Manila", size: 3, timezone: "Asia/Manila" }, { name: "Mexico City", size: 5, timezone: "America/Mexico_City" }, { name: "Moscow", size: 4, timezone: "Europe/Moscow" }, { name: "Mumbai", size: 4, timezone: "Asia/Kolkata" },
    { name: "New York", size: 5, timezone: "America/New_York" }, { name: "Paris", size: 4, timezone: "Europe/Paris" }, { name: "Rio de Janeiro", size: 3, timezone: "America/Sao_Paulo" },
    { name: "Seoul", size: 4, timezone: "Asia/Seoul" }, { name: "Shanghai", size: 4, timezone: "Asia/Shanghai" }, { name: "Singapore", size: 4, timezone: "Asia/Singapore" }, { name: "Sydney", size: 4, timezone: "Australia/Sydney" }, { name: "São Paulo", size: 5, timezone: "America/Sao_Paulo" }, { name: "Taipei", size: 3, timezone: "Asia/Taipei" },
    { name: "Tokyo", size: 5, timezone: "Asia/Tokyo" },
];

const translations = {
    en: { name: "English", ui: { notes: "Notes for", calendar: "Calendar", settings: "Settings", theme: "Theme", autoTheme: "Auto Theme", darkMode: "Dark Mode", format: "Format", hourFormat: "24-Hour Format", language: "Language", reset: "Reset All Data", allNotes: "All Notes", showAllNotes: "Show All Notes", noNotes: "No notes found." }, placeholders: { search: "Search for a city or country...", notes: "Write something for the selected date..." }, alerts: { resetConfirm: "Are you sure? This will clear all pinned clocks and notes.", noPinned: "Search for a city to pin a clock." }, time: { ahead: "ahead", behind: "behind", same: "Same time" }, calendar: { months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"], shortMonths: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dic"], weekdays: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"] } },
    bn: { name: "বাংলা (Bangla)", ui: { notes: "নোট", calendar: "ক্যালেন্ডার", settings: "সেটিংস", theme: "থিম", autoTheme: "স্বয়ংক্রিয় থিম", darkMode: "ডার্ক মোড", format: "ফরম্যাট", hourFormat: "২৪-ঘন্টা ফরম্যাট", language: "ভাষা", reset: "সব ডেটা রিসেট করুন", allNotes: "সমস্ত নোট", showAllNotes: "সব নোট দেখুন", noNotes: "কোন নোট পাওয়া যায়নি।" }, placeholders: { search: "শহর বা দেশ খুঁজুন...", notes: "কিছু লিখুন..." }, alerts: { resetConfirm: "আপনি কি নিশ্চিত? এটি সমস্ত পিন করা ঘড়ি এবং নোট মুছে ফেলবে।", noPinned: "ঘড়ি পিন করতে একটি শহর অনুসন্ধান করুন।" }, time: { ahead: "এগিয়ে", behind: "পিছিয়ে", same: "একই সময়" }, calendar: { months: ["জানুয়ারী", "ফেব্রুয়ারী", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"], shortMonths: ["জানু", "ফেব্রু", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টে", "অক্টো", "নভে", "ডিসে"], weekdays: ["রবি", "সোম", "মঙ্গল", "বুধ", "বৃহঃ", "শুক্র", "শনি"] } },
    es: { name: "Español", ui: { notes: "Notes for", calendar: "Calendario", settings: "Ajustes", theme: "Tema", autoTheme: "Tema automático", darkMode: "Modo oscuro", format: "Formato", hourFormat: "Formato 24 horas", language: "Idioma", reset: "Restablecer datos", allNotes: "Todas las notas", showAllNotes: "Mostrar todas las notas", noNotes: "No se encontraron notas." }, placeholders: { search: "Buscar una ciudad o país...", notes: "Escribe algo para la fecha seleccionada..." }, alerts: { resetConfirm: "¿Estás seguro? Esto borrará todos los relojes y notas fijados.", noPinned: "Busca una ciudad para fijar un reloj." }, time: { ahead: "adelantado", behind: "atrasado", same: "Misma hora" }, calendar: { months: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"], shortMonths: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"], weekdays: ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"] } }
};

// --- Page Navigation Switching ---
const switchPage = (targetPage) => {
     // Hide all sections
     document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
    });

    // Show selected section
    const targetSection = document.getElementById(`page-${targetPage}`);
    if (targetSection) {
        targetSection.classList.add('active');
    }

    // Update nav link active class
    dom.navLinks.forEach(nav => {
        nav.classList.toggle('active', nav.getAttribute('data-page') === targetPage);
    });

    // Close menu
    dom.navOverlay.classList.remove('active');
}

// --- 2. CORE LOGIC & HELPERS ---

// Helper to get a date string in YYYY-MM-DD format
const getDateString = (date) => {
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
};

// Helper to compare if two dates are the same day
const isSameDay = (d1, d2) => {
  return d1.getFullYear() === d2.getFullYear() &&
         d1.getMonth() === d2.getMonth() &&
         d1.getDate() === d2.getDate();
};


// A helper function to prevent a function from being called too frequently.
// Useful for things like search input to avoid making API calls on every keystroke.
const debounce = (func, timeout = 300) => {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
};

// Fetches time data from the WorldTimeAPI for a given timezone.
// It calculates the 'offset' - the difference between the API's time and the user's browser time.
// This offset is used to calculate the correct time locally without needing to call the API every second.
const createClockObject = async (timezone) => {
    try {
        const response = await fetch(`${API_BASE_URL}/timezone/${timezone}`);
        if (!response.ok) throw new Error(`API fetch failed for ${timezone}`);
        const data = await response.json();
        const cityInfo = cityData.find(c => c.timezone === data.timezone) || {};
        return { ...data, ...cityInfo, offset: new Date(data.utc_datetime).getTime() - Date.now(), apiFailed: false };
    } catch (error) {
        console.warn(`${error.message}. Falling back to browser time.`);
        const cityInfo = cityData.find(c => c.timezone === timezone) || {};
        return { timezone, ...cityInfo, apiFailed: true, offset: 0 };
    }
};

// A helper function to get the current hour (0-23) in a specific timezone.
// This is used to determine if it's day or night for styling the clock cards.
const getHourInTimezone = (date, timezone) => {
    const formatter = new Intl.DateTimeFormat('en-US', {
        hour: 'numeric',
        hour12: false,
        timeZone: timezone,
    });
    return parseInt(formatter.format(date), 10);
};

// The main function that updates all visible clocks every second.
const updateAllClocks = () => {
    const now = Date.now();
    
    // Update the main clock
    if (state.mainClock) {
        const mainTime = new Date(now + state.mainClock.offset);
        const formattedTime = formatTime(mainTime, state.mainClock.timezone);
        const formattedDate = formatDate(mainTime, state.mainClock.timezone);

        dom.mainTime.textContent = formattedTime;
        dom.mainDate.textContent = formattedDate;
        
        if (dom.fullscreenOverlay.classList.contains('active')) {
            dom.fullscreenTime.textContent = formattedTime;
            dom.fullscreenDate.textContent = formattedDate;
        }
    }
    
    // Update all the pinned city clocks
    state.pinnedClocks.forEach(clock => {
        const card = document.querySelector(`.clock-card[data-timezone="${clock.timezone}"]`);
        if (card) {
            // Self-healing: If data is missing, trigger a refresh
            if (!clock.utc_offset && !clock.isRefreshing) {
                clock.isRefreshing = true; // Prevent multiple requests
                (async () => {
                    console.log(`Data for ${clock.timezone} is missing. Auto-refreshing...`);
                    const refreshedClock = await createClockObject(clock.timezone);
                    const index = state.pinnedClocks.findIndex(c => c.timezone === refreshedClock.timezone);
                    if (index !== -1) {
                        state.pinnedClocks[index] = refreshedClock;
                    }
                })();
            }

            const clockTime = new Date(now + clock.offset);
            const hourInTimezone = getHourInTimezone(clockTime, clock.timezone);
            const isDay = hourInTimezone >= 6 && hourInTimezone < 18;

            card.querySelector('.time').textContent = formatTime(clockTime, clock.timezone);
            card.querySelector('.date').textContent = formatDate(clockTime, clock.timezone, 'short');
            card.querySelector('.day-night-indicator').textContent = isDay ? '☀️' : '🌙';
            
            card.classList.toggle('card-day', isDay);
            card.classList.toggle('card-night', !isDay);
            
            const timeDifferenceEl = card.querySelector('.time-difference');
            if (timeDifferenceEl) {
                timeDifferenceEl.innerHTML = calculateTimeDifference(clock);
            }
        }
    });

    // Update the countdowns for all active alarms
    updateAlarmCountdowns();
};

// Adds a new city clock to the dashboard.
const addClock = async (timezone) => {
    if (state.pinnedClocks.some(c => c.timezone === timezone)) return; // Avoid duplicates
    const newClock = await createClockObject(timezone);
    if (newClock) {
        state.pinnedClocks.push(newClock);
        renderPinnedClocks();
        saveState();
    }
};

// Removes a city clock from the dashboard.
const removeClock = (timezone) => {
    state.pinnedClocks = state.pinnedClocks.filter(c => c.timezone !== timezone);
    renderPinnedClocks();
    saveState();
};

// Calculates and formats the time difference between a pinned clock and the main clock.
const calculateTimeDifference = (clock) => {
    const t = translations[state.settings.language];
    if (!state.mainClock || clock.utc_offset === undefined || state.mainClock.utc_offset === undefined) {
        return ''; // Not enough data to calculate
    }

    const timezoneInfo = `${clock.abbreviation || ''} UTC${clock.utc_offset}`;
    
    const mainTotalOffsetSeconds = state.mainClock.raw_offset + (state.mainClock.dst_offset || 0);
    const clockTotalOffsetSeconds = clock.raw_offset + (clock.dst_offset || 0);
    const diffSeconds = clockTotalOffsetSeconds - mainTotalOffsetSeconds;
    const diffHours = diffSeconds / 3600;

    let diffFromMainText = '';
    const mainClockName = state.mainClock.name || 'your location';
    if (Math.abs(diffHours) < 0.01) {
        diffFromMainText = ` &nbsp;&nbsp; | &nbsp;&nbsp; ${t.time.same} as ${mainClockName}`;
    } else {
        const behindOrAhead = diffHours < 0 ? t.time.behind : t.time.ahead;
        const hoursDisplay = Math.abs(diffHours).toString().replace('.5', '.5').replace('.0', '');
        diffFromMainText = ` &nbsp;&nbsp; | &nbsp;&nbsp; ${hoursDisplay} hours ${behindOrAhead} ${mainClockName}`;
    }

    return `${timezoneInfo}${diffFromMainText}`;
};

// --- 3. UTILITY (STOPWATCH, TIMER, ALARM) LOGIC ---

// Stopwatch logic
const updateStopwatchDisplay = () => {
    const now = Date.now();
    const time = state.stopwatch.elapsedTime + (state.stopwatch.startTime ? now - state.stopwatch.startTime : 0);
    const ms = Math.floor((time % 1000) / 10).toString().padStart(2, '0');
    const s = Math.floor((time / 1000) % 60).toString().padStart(2, '0');
    const m = Math.floor((time / (1000 * 60)) % 60).toString().padStart(2, '0');
    const h = Math.floor(time / (1000 * 60 * 60)).toString().padStart(2, '0');
    dom.stopwatchDisplay.innerHTML = `${h}:${m}:${s}<span class="milliseconds">.${ms}</span>`;
};

const renderLaps = () => {
    dom.lapsList.innerHTML = '';
    state.stopwatch.laps.forEach((lap, index) => {
        const lapItem = document.createElement('li');
        lapItem.className = 'lap-item';
        lapItem.innerHTML = `<span class="lap-number">Lap ${index + 1}</span><span>${lap.time}</span>`;
        dom.lapsList.prepend(lapItem);
    });
};

// Timer logic
const playTimerSound = () => {
    try {
        // Use Tone.js for a pleasant sound effect
        const synth = new Tone.Synth().toDestination();
        synth.triggerAttackRelease("C5", "0.5s", Tone.now());
        synth.triggerAttackRelease("G4", "0.5s", Tone.now() + 0.5);
    } catch (e) {
        // Fallback to a simple alert if Tone.js fails
        alert('⏰ Timer finished!');
        console.error("Tone.js could not play sound.", e);
    }
};

const updateTimerDisplay = () => {
    const s = state.timer.remainingSeconds;
    const hrs = Math.floor(s / 3600).toString().padStart(2, '0');
    const mins = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
    const secs = Math.floor(s % 60).toString().padStart(2, '0');
    dom.timerDisplay.textContent = `${hrs}:${mins}:${secs}`;
};

// Alarm logic
 const playAlarmSound = (label) => {
    try {
        const synth = new Tone.Synth().toDestination();
        synth.triggerAttackRelease("A5", "0.2s", Tone.now());
        synth.triggerAttackRelease("A5", "0.2s", Tone.now() + 0.3);
    } catch(e) { console.error("Tone.js could not play sound.", e); }
    alert(`⏰ ${label}`);
};

 const checkAlarms = () => {
    const now = new Date();
    const currentTime = now.toTimeString().substring(0, 5); // Format: "HH:MM"
    let stateChanged = false;

    state.alarms.forEach(alarm => {
        if (alarm.enabled && alarm.time === currentTime) {
            if (!alarm.triggeredToday) {
                playAlarmSound(alarm.label);
                alarm.triggeredToday = true;
                stateChanged = true;
            }
        } else {
            if (alarm.triggeredToday) {
               alarm.triggeredToday = false; // Reset for the next day
               stateChanged = true;
            }
        }
    });

    if (stateChanged) saveState();
};

// This function calculates and displays the remaining time for each alarm.
const updateAlarmCountdowns = () => {
    const now = new Date();
    state.alarms.forEach(alarm => {
        const countdownEl = document.querySelector(`.alarm-card[data-id="${alarm.id}"] .alarm-countdown`);
        if (!countdownEl) return;

        if (!alarm.enabled) {
            countdownEl.textContent = ''; // Clear countdown if alarm is off
            return;
        }

        const [hours, minutes] = alarm.time.split(':');
        let alarmTime = new Date();
        alarmTime.setHours(hours, minutes, 0, 0);

        // If the alarm time for today has already passed, set it for tomorrow
        if (alarmTime < now) {
            alarmTime.setDate(alarmTime.getDate() + 1);
        }

        const diff = alarmTime - now; // Difference in milliseconds
        if (diff > 0) {
            const h = Math.floor(diff / 1000 / 60 / 60);
            const m = Math.floor((diff / 1000 / 60) % 60);
            const s = Math.floor((diff / 1000) % 60);
            countdownEl.textContent = `Rings in ${h}h ${m}m ${s}s`;
        } else {
            countdownEl.textContent = '';
        }
    });
};

// --- 4. UI RENDERING & FORMATTING ---

const updateNotesSection = () => {
    const t = translations[state.settings.language];
    const selectedDateString = getDateString(state.selectedDate);
    const formattedDate = state.selectedDate.toLocaleDateString(state.settings.language, {
        year: 'numeric', month: 'long', day: 'numeric'
    });
    
    dom.uiText.notesTitle.textContent = `${t.ui.notes} ${formattedDate}`;
    dom.notesArea.value = state.notes[selectedDateString] || '';
    dom.notesArea.placeholder = t.placeholders.notes;
};

// Renders the list of alarms from the state.
const renderAlarms = () => {
    dom.alarmsList.innerHTML = '';
    if (!state.alarms) state.alarms = []; // Ensure alarms is an array
    state.alarms.forEach((alarm) => {
        const li = document.createElement('li');
        li.className = 'alarm-item';

        const card = document.createElement('div');
        card.className = `alarm-card ${alarm.enabled ? '' : 'disabled'}`;
        card.dataset.id = alarm.id;

        // The HTML for each alarm card, now including the countdown element.
        card.innerHTML = `
            <div class="alarm-card-details">
                <div class="alarm-card-time">${alarm.time}</div>
                <div class="alarm-card-label">${alarm.label}</div>
                <div class="alarm-countdown"></div>
            </div>
            <div class="alarm-card-controls">
                <label class="toggle-switch">
                    <input type="checkbox" class="alarm-toggle-cb" ${alarm.enabled ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
                <button class="delete-alarm-btn">✕</button>
            </div>
        `;
        li.appendChild(card);
        dom.alarmsList.appendChild(li);
    });
    updateAlarmCountdowns(); // Update countdowns immediately after rendering
};

// Renders the grid of pinned city clocks.
const renderPinnedClocks = () => {
    dom.clocksGrid.innerHTML = '';
    const t = translations[state.settings.language];

    if (state.pinnedClocks.length === 0) {
        dom.clocksGrid.innerHTML = `<p style="opacity: 0.7; grid-column: 1 / -1; text-align: center;">${t.alerts.noPinned}</p>`;
        return;
    }
    state.pinnedClocks.forEach(clock => {
        const card = document.createElement('div');
        card.className = 'clock-card';
        card.dataset.timezone = clock.timezone;
        
        card.innerHTML = `
            <div class="day-night-indicator"></div>
            <button class="remove-card-btn">✕</button>
            <div class="clock-card-header">
                <div class="clock-card-title">
                    <span class="flag">${clock.flag || '🌐'}</span>
                    <span class="city-name">${clock.name || clock.timezone.split('/').pop().replace(/_/g, ' ')}</span>
                </div>
            </div>
            <div class="time">--:--:--</div>
            <div class="date">Loading...</div>
            <div class="time-difference"></div>
        `;
        dom.clocksGrid.appendChild(card);
        card.querySelector('.remove-card-btn').addEventListener('click', () => removeClock(clock.timezone));
    });
    updateAllClocks(); // Call once to populate initial data immediately
};

const renderCalendar = () => {
    const date = state.currentCalendarDate;
    const year = date.getFullYear();
    const month = date.getMonth();
    const t = translations[state.settings.language].calendar;

    dom.calendarTitleText.textContent = `${t.months[month]} ${year}`;
    
    dom.calendarGrid.innerHTML = '';
    
    // Create header row
    const headerRow = document.createElement('div');
    headerRow.style.gridColumn = '1 / -1';
    headerRow.style.display = 'grid';
    headerRow.style.gridTemplateColumns = 'repeat(7, 1fr)';
    headerRow.style.marginBottom = '0.5rem';
    t.weekdays.forEach(day => {
        headerRow.innerHTML += `<div class="calendar-day-header">${day}</div>`;
    });
    dom.calendarGrid.appendChild(headerRow);


    const firstDayOfMonth = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    for (let i = 0; i < firstDayOfMonth; i++) {
        dom.calendarGrid.innerHTML += `<div></div>`;
    }

    const today = new Date();
    for (let i = 1; i <= daysInMonth; i++) {
        const dayEl = document.createElement('div');
        const thisDate = new Date(year, month, i);
        const dateString = getDateString(thisDate);

        dayEl.className = 'calendar-day';
        dayEl.textContent = i;
        dayEl.dataset.date = dateString;

        if (isSameDay(thisDate, today)) {
            dayEl.classList.add('today');
        }
        if (isSameDay(thisDate, state.selectedDate)) {
            dayEl.classList.add('selected');
        }
        if (state.notes[dateString]) {
            dayEl.classList.add('has-note');
        }

        dom.calendarGrid.appendChild(dayEl);
    }
};

const renderDatePicker = (targetYear) => {
    const t = translations[state.settings.language].calendar;
    dom.pickerYearInput.value = targetYear;
    dom.datePickerMonthsGrid.innerHTML = '';

    t.shortMonths.forEach((monthName, index) => {
        const monthBtn = document.createElement('button');
        monthBtn.className = 'month-btn';
        monthBtn.textContent = monthName;
        monthBtn.dataset.month = index;
        
        if (index === state.currentCalendarDate.getMonth() && targetYear === state.currentCalendarDate.getFullYear()) {
            monthBtn.classList.add('active');
        }
        
        monthBtn.addEventListener('click', () => {
            state.currentCalendarDate.setFullYear(targetYear, index, 1);
            renderCalendar();
            dom.datePickerModal.classList.remove('active');
        });
        dom.datePickerMonthsGrid.appendChild(monthBtn);
    });
};

const renderPopularCities = () => {
    const cityCloud = document.getElementById('city-cloud');
    if (!cityCloud) return;
    cityCloud.innerHTML = '';

    popularCities.forEach(city => {
        const citySpan = document.createElement('span');
        citySpan.textContent = city.name;
        citySpan.className = `city-item size-${city.size}`;
        citySpan.addEventListener('click', () => addClock(city.timezone));
        cityCloud.appendChild(citySpan);
    });
};

const renderAllNotesModal = () => {
    const t = translations[state.settings.language];
    dom.allNotesContent.innerHTML = '';
    const sortedNoteKeys = Object.keys(state.notes).sort();

    if (sortedNoteKeys.length === 0) {
        dom.allNotesContent.textContent = t.ui.noNotes;
        return;
    }

    sortedNoteKeys.forEach(dateKey => {
        const noteText = state.notes[dateKey];
        if (noteText && noteText.trim()) {
            const noteEntry = document.createElement('div');
            noteEntry.className = 'note-entry';
            
            const noteDate = document.createElement('div');
            noteDate.className = 'note-date';
            const date = new Date(dateKey + 'T00:00:00');
            noteDate.textContent = date.toLocaleDateString(state.settings.language, {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            const noteContent = document.createElement('div');
            noteContent.className = 'note-text';
            noteContent.textContent = noteText;

            noteEntry.appendChild(noteDate);
            noteEntry.appendChild(noteContent);
            dom.allNotesContent.appendChild(noteEntry);
        }
    });
};

const applyTheme = () => {
    if (state.settings.autoTheme) {
        if (state.mainClock) {
            const hour = getHourInTimezone(new Date(Date.now() + state.mainClock.offset), state.mainClock.timezone);
            dom.body.className = (hour >= 6 && hour < 18) ? 'light-theme' : 'dark-theme';
        } else {
            dom.body.className = 'light-theme';
        }
    } else {
        dom.body.className = state.settings.manualThemeDark ? 'dark-theme' : 'light-theme';
    }
    dom.manualThemeToggle.disabled = state.settings.autoTheme;
    dom.manualThemeToggleContainer.style.opacity = state.settings.autoTheme ? 0.5 : 1;
};

const applyLanguage = () => {
    const lang = state.settings.language;
    const t = translations[lang];
    
    updateNotesSection();
    dom.uiText.calendarSectionTitle.textContent = t.ui.calendar;
    dom.uiText.settingsModalTitle.textContent = t.ui.settings;
    dom.uiText.themeSettingsTitle.textContent = t.ui.theme;
    dom.uiText.autoThemeLabel.textContent = t.ui.autoTheme;
    dom.uiText.darkThemeLabel.textContent = t.ui.darkMode;
    dom.uiText.formatSettingsTitle.textContent = t.ui.format;
    dom.uiText.hourFormatLabel.textContent = t.ui.hourFormat;
    dom.uiText.languageSettingsTitle.textContent = t.ui.language;
    dom.uiText.allNotesTitle.textContent = t.ui.allNotes;
    dom.uiText.showAllNotesBtn.textContent = t.ui.showAllNotes;


    dom.citySearchInput.placeholder = t.placeholders.search;
    dom.resetBtn.textContent = t.ui.reset;
    
    renderCalendar();
    renderPinnedClocks();
    renderPopularCities();
};

const formatTime = (date, timezone) => {
    const locale = state.settings.language === 'bn' ? 'bn-BD' : state.settings.language;
    return date.toLocaleTimeString(locale, {
        timeZone: timezone,
        hour12: !state.settings.is24Hour,
        hour: '2-digit', minute: '2-digit', second: '2-digit'
    });
};

const formatDate = (date, timezone, format = 'long') => {
    const locale = state.settings.language === 'bn' ? 'bn-BD' : state.settings.language;
    return date.toLocaleDateString(locale, {
        timeZone: timezone,
        weekday: format, year: 'numeric', month: format, day: 'numeric'
    });
};

// --- QUOTE LOGIC ---
const getDayOfYear = (date) => {
    const start = new Date(date.getFullYear(), 0, 0);
    const diff = date - start;
    const oneDay = 1000 * 60 * 60 * 24;
    return Math.floor(diff / oneDay);
};

function changeQuote() {
    const today = new Date();
    const dayOfYear = getDayOfYear(today);
    const quoteIndex = dayOfYear % quotes.length;
    const newQuote = quotes[quoteIndex];

    dom.quoteText.textContent = newQuote.text;
    dom.quoteAuthor.textContent = `– ${newQuote.author}`;
    const cursorEl = dom.quoteContainer.querySelector('.cursor');
    if (cursorEl) {
        cursorEl.style.display = 'none'; // Ensure cursor is always hidden
    }
}


// --- Sound Player & Focus Mode Logic ---
function activateFocusMode() {
    const videoId = "ztVV54sPOns";
    const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1&playlist=${videoId}&controls=0&showinfo=0&modestbranding=1&enablejsapi=1`;
    dom.focusVideoPlayer.src = embedUrl;
    dom.fullscreenOverlay.classList.add('active', 'focus-active');
}

function deactivateFocusMode() {
    dom.focusVideoPlayer.src = '';
    dom.fullscreenOverlay.classList.remove('focus-active');
    
    const focusBtn = document.querySelector('.sound-btn[data-video-id="ztVV54sPOns"]');
    if (focusBtn) {
        focusBtn.classList.remove('active');
    }
}

const setupSoundPlayer = () => {
    const soundButtons = document.querySelectorAll('.sound-btn');
    const youtubePlayer = document.getElementById('youtube-player');
    let currentlyPlayingButton = null;
    const focusVideoId = "ztVV54sPOns";

    soundButtons.forEach(button => {
        button.addEventListener('click', () => {
            const videoId = button.dataset.videoId;
            const isFocusButton = (videoId === focusVideoId);

            if (isFocusButton) {
                if (button.classList.contains('active')) {
                    deactivateFocusMode();
                    dom.fullscreenOverlay.classList.remove('active');
                    currentlyPlayingButton = null;
                } else {
                    if (currentlyPlayingButton) {
                        currentlyPlayingButton.classList.remove('active');
                        youtubePlayer.src = '';
                    }
                    activateFocusMode();
                    button.classList.add('active');
                    currentlyPlayingButton = button;
                }
                return; 
            }

            deactivateFocusMode();

            if (currentlyPlayingButton === button) {
                youtubePlayer.src = '';
                button.classList.remove('active');
                currentlyPlayingButton = null;
            } else {
                if (currentlyPlayingButton) {
                    currentlyPlayingButton.classList.remove('active');
                }
                const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1&playlist=${videoId}&controls=0&enablejsapi=1`;
                youtubePlayer.src = embedUrl;
                button.classList.add('active');
                currentlyPlayingButton = button;
            }
        });
    });
};

const setupEventListeners = () => {
    const toggleModal = (modal, show) => {
        modal.classList.toggle('active', show);
    };
    
    dom.logoLink.addEventListener('click', () => switchPage('time'));
    dom.mainClockContainer.addEventListener('click', (e) => {
        if (e.target.closest('.sound-btn')) {
            return;
        }
        toggleModal(dom.fullscreenOverlay, true);
    });
    dom.fullscreenOverlay.addEventListener('click', (e) => {
        toggleModal(dom.fullscreenOverlay, false);
        deactivateFocusMode();
    });
    dom.settingsBtn.addEventListener('click', () => toggleModal(dom.settingsModal, true));
    dom.closeSettingsBtn.addEventListener('click', () => toggleModal(dom.settingsModal, false));
    dom.menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleModal(dom.navOverlay, true)
    });

    dom.calendarTitleText.addEventListener('click', () => {
        renderDatePicker(state.currentCalendarDate.getFullYear());
        toggleModal(dom.datePickerModal, true);
    });
    dom.closeDatePickerBtn.addEventListener('click', () => toggleModal(dom.datePickerModal, false));
    
    dom.showAllNotesBtn.addEventListener('click', () => {
        renderAllNotesModal();
        toggleModal(dom.allNotesModal, true);
    });
    dom.closeAllNotesBtn.addEventListener('click', () => toggleModal(dom.allNotesModal, false));
    
    [dom.settingsModal, dom.datePickerModal, dom.navOverlay, dom.allNotesModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                toggleModal(modal, false);
            }
        });
    });

    dom.prevYearBtn.addEventListener('click', () => {
        const newYear = parseInt(dom.pickerYearInput.value) - 1;
        renderDatePicker(newYear);
    });
    dom.nextYearBtn.addEventListener('click', () => {
        const newYear = parseInt(dom.pickerYearInput.value) + 1;
        renderDatePicker(newYear);
    });
    dom.pickerYearInput.addEventListener('change', () => {
        const newYear = parseInt(dom.pickerYearInput.value);
        if (!isNaN(newYear)) {
            renderDatePicker(newYear);
        } else {
            renderDatePicker(state.currentCalendarDate.getFullYear());
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === "Escape") {
            if (dom.fullscreenOverlay.classList.contains('active')) {
                deactivateFocusMode();
            }
            [dom.fullscreenOverlay, dom.settingsModal, dom.navOverlay, dom.datePickerModal, dom.allNotesModal].forEach(modal => toggleModal(modal, false));
        }
    });

    dom.autoThemeToggle.addEventListener('change', (e) => {
        state.settings.autoTheme = e.target.checked;
        applyTheme();
        saveState();
    });
    dom.manualThemeToggle.addEventListener('change', (e) => {
        state.settings.manualThemeDark = e.target.checked;
        applyTheme();
        saveState();
    });
    dom.hourFormatToggle.addEventListener('change', (e) => {
        state.settings.is24Hour = e.target.checked;
        updateAllClocks();
        saveState();
    });
    dom.languageSelect.addEventListener('change', (e) => {
        state.settings.language = e.target.value;
        applyLanguage();
        saveState();
    });

    const handleSearchInput = debounce(() => {
        const query = dom.citySearchInput.value.toLowerCase();
        dom.searchDropdown.innerHTML = '';
        if (query) {
            const filteredCities = cityData.filter(c => 
                c.name.toLowerCase().includes(query) || 
                c.country.toLowerCase().includes(query)
            );
            filteredCities.forEach(city => {
                const item = document.createElement('div');
                item.className = 'search-dropdown-item';
                item.innerHTML = `<span class="flag">${city.flag}</span> <span class="city-name">${city.name}</span>`;
                item.addEventListener('click', () => {
                    addClock(city.timezone);
                    dom.citySearchInput.value = '';
                    dom.searchDropdown.classList.remove('active');
                });
                dom.searchDropdown.appendChild(item);
            });
            dom.searchDropdown.classList.toggle('active', filteredCities.length > 0);
        } else {
            dom.searchDropdown.classList.remove('active');
        }
    });
    dom.citySearchInput.addEventListener('input', handleSearchInput);
    document.addEventListener('click', (e) => {
        if (!dom.searchContainer.contains(e.target)) {
            dom.searchDropdown.classList.remove('active');
        }
    });

    dom.popularCitiesContainer.querySelectorAll('.timezone-item').forEach(item => {
        item.addEventListener('click', () => {
            const tz = item.textContent;
            let ianaTimezone;
            switch(tz) {
                case 'UTC': ianaTimezone = 'Etc/UTC'; break;
                case 'GMT': ianaTimezone = 'Etc/GMT'; break;
                case 'CET': ianaTimezone = 'CET'; break;
                case 'Pacific Time': ianaTimezone = 'America/Los_Angeles'; break;
                case 'Mountain Time': ianaTimezone = 'America/Denver'; break;
                case 'Central Time': ianaTimezone = 'America/Chicago'; break;
                case 'Eastern Time': ianaTimezone = 'America/New_York'; break;
                case 'China Standard Time': ianaTimezone = 'Asia/Shanghai'; break;
                case 'India Standard Time': ianaTimezone = 'Asia/Kolkata'; break;
                default: return;
            }
            addClock(ianaTimezone);
        });
    });

    dom.notesArea.addEventListener('input', debounce(() => {
        const selectedDateString = getDateString(state.selectedDate);
        const noteText = dom.notesArea.value;

        if (noteText.trim()) {
            state.notes[selectedDateString] = noteText;
        } else {
            delete state.notes[selectedDateString];
        }
        renderCalendar();
        saveState();
    }, 500));

    dom.resetBtn.addEventListener('click', () => {
        const t = translations[state.settings.language];
        if (window.confirm(t.alerts.resetConfirm)) {
            localStorage.removeItem('airclockState');
            window.location.reload();
        }
    });
    
    dom.refreshCardsBtn.addEventListener('click', async () => {
        const clocksToRefresh = state.pinnedClocks;
        if (clocksToRefresh.length === 0) return;
        dom.refreshCardsBtn.disabled = true;

        const refreshPromises = clocksToRefresh.map(clock => createClockObject(clock.timezone));
        const refreshedClocks = await Promise.all(refreshPromises);

        refreshedClocks.forEach(refreshedClock => {
            const index = state.pinnedClocks.findIndex(c => c.timezone === refreshedClock.timezone);
            if (index !== -1) state.pinnedClocks[index] = refreshedClock;
        });

        renderPinnedClocks();
        saveState();
        dom.refreshCardsBtn.disabled = false;
    });

    dom.prevMonthBtn.addEventListener('click', () => {
        state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() - 1);
        renderCalendar();
    });
    dom.nextMonthBtn.addEventListener('click', () => {
        state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() + 1);
        renderCalendar();
    });
    
    dom.calendarGrid.addEventListener('click', (e) => {
        const dayEl = e.target.closest('.calendar-day');
        if (dayEl && dayEl.dataset.date) {
            state.selectedDate = new Date(dayEl.dataset.date + 'T00:00:00');
            renderCalendar();
            updateNotesSection();
        }
    });

    dom.stopwatchToggleBtn.addEventListener('click', () => {
        if (state.stopwatch.intervalId) {
            clearInterval(state.stopwatch.intervalId);
            state.stopwatch.elapsedTime += Date.now() - state.stopwatch.startTime;
            state.stopwatch.intervalId = null;
            state.stopwatch.startTime = 0;
            dom.stopwatchToggleBtn.textContent = 'Start';
            dom.stopwatchToggleBtn.classList.replace('stop-btn', 'start-btn');
        } else {
            state.stopwatch.startTime = Date.now();
            state.stopwatch.intervalId = setInterval(updateStopwatchDisplay, 10);
            dom.stopwatchToggleBtn.textContent = 'Stop';
            dom.stopwatchToggleBtn.classList.replace('start-btn', 'stop-btn');
        }
    });

    dom.stopwatchResetBtn.addEventListener('click', () => {
        clearInterval(state.stopwatch.intervalId);
        state.stopwatch = { startTime: 0, elapsedTime: 0, intervalId: null, laps: [] };
        dom.stopwatchDisplay.innerHTML = `00:00:00<span class="milliseconds">.00</span>`;
        renderLaps();
        dom.stopwatchToggleBtn.textContent = 'Start';
        dom.stopwatchToggleBtn.classList.replace('stop-btn', 'start-btn');
    });

    dom.stopwatchLapBtn.addEventListener('click', () => {
        if (state.stopwatch.intervalId) {
            const lapTime = dom.stopwatchDisplay.innerHTML;
            state.stopwatch.laps.push({ time: lapTime });
            renderLaps();
        }
    });

    dom.timerToggleBtn.addEventListener('click', () => {
        if (state.timer.intervalId) {
            clearInterval(state.timer.intervalId);
            state.timer.intervalId = null;
            dom.timerInputsContainer.style.display = 'flex';
            dom.timerToggleBtn.textContent = 'Start';
            dom.timerToggleBtn.classList.replace('stop-btn', 'start-btn');
        } else {
            let totalSeconds = parseInt(dom.timerHoursInput.value) * 3600 +
                               parseInt(dom.timerMinutesInput.value) * 60 +
                               parseInt(dom.timerSecondsInput.value);

            if (totalSeconds <= 0) return;
            
            state.timer.remainingSeconds = totalSeconds;
            dom.timerInputsContainer.style.display = 'none';
            updateTimerDisplay();
            dom.timerToggleBtn.textContent = 'Stop';
            dom.timerToggleBtn.classList.replace('start-btn', 'stop-btn');

            state.timer.intervalId = setInterval(() => {
                state.timer.remainingSeconds--;
                updateTimerDisplay();
                if (state.timer.remainingSeconds <= 0) {
                    clearInterval(state.timer.intervalId);
                    state.timer.intervalId = null;
                    dom.timerInputsContainer.style.display = 'flex';
                    dom.timerToggleBtn.textContent = 'Start';
                    dom.timerToggleBtn.classList.replace('stop-btn', 'start-btn');
                    playTimerSound();
                }
            }, 1000);
        }
    });

    dom.timerResetBtn.addEventListener('click', () => {
        if (state.timer.intervalId) clearInterval(state.timer.intervalId);
        state.timer = { totalSeconds: 0, remainingSeconds: 0, intervalId: null };
        dom.timerHoursInput.value = "0";
        dom.timerMinutesInput.value = "10";
        dom.timerSecondsInput.value = "0";
        dom.timerInputsContainer.style.display = 'flex';
        updateTimerDisplay();
        dom.timerToggleBtn.textContent = 'Start';
        dom.timerToggleBtn.classList.replace('stop-btn', 'start-btn');
    });
    
    dom.addAlarmBtn.addEventListener('click', () => {
        const time = dom.alarmTimeInput.value;
        const label = dom.alarmLabelInput.value.trim() || 'Alarm';
        if (!time || state.alarms.some(a => a.time === time)) return;

        const newAlarm = { id: Date.now(), time, label, enabled: true, triggeredToday: false };
        state.alarms.push(newAlarm);
        
        dom.alarmTimeInput.value = '';
        dom.alarmLabelInput.value = '';

        renderAlarms();
        saveState();
    });
    
    dom.alarmsList.addEventListener('click', (e) => {
        const alarmCard = e.target.closest('.alarm-card');
        if (!alarmCard) return;

        const alarmId = parseInt(alarmCard.dataset.id);
        const alarm = state.alarms.find(a => a.id === alarmId);
        if (!alarm) return;

        if (e.target.classList.contains('delete-alarm-btn')) {
            state.alarms = state.alarms.filter(a => a.id !== alarmId);
            renderAlarms();
        } 
        else if (e.target.classList.contains('alarm-toggle-cb')) {
            alarm.enabled = e.target.checked;
            alarmCard.classList.toggle('disabled', !alarm.enabled);
            updateAlarmCountdowns();
        }
        saveState();
    });
};

const saveState = () => {
    const stateToSave = {
        pinnedTimezones: state.pinnedClocks.map(c => c.timezone),
        notes: state.notes,
        settings: state.settings,
        alarms: state.alarms
    };
    localStorage.setItem('airclockState', JSON.stringify(stateToSave));
};

const loadState = async () => {
    const savedState = JSON.parse(localStorage.getItem('airclockState'));
    if (savedState) {
        state.notes = savedState.notes || {};
        state.settings = { ...state.settings, ...savedState.settings };
        state.alarms = savedState.alarms ? savedState.alarms.map(a => ({...a, enabled: a.enabled !== false, triggeredToday: false })) : [];
        
        if (savedState.pinnedTimezones && savedState.pinnedTimezones.length > 0) {
           const clockPromises = savedState.pinnedTimezones.map(timezone => createClockObject(timezone));
           const loadedClocks = await Promise.all(clockPromises);
           state.pinnedClocks = loadedClocks.filter(clock => clock);
        }
    }
};

const populateLanguageSelector = () => {
    dom.languageSelect.innerHTML = '';
    for(const langCode in translations) {
        const option = document.createElement('option');
        option.value = langCode;
        option.textContent = translations[langCode].name;
        dom.languageSelect.appendChild(option);
    }
}

const init = async () => {
    populateLanguageSelector();
    await loadState();
    
    dom.autoThemeToggle.checked = state.settings.autoTheme;
    dom.manualThemeToggle.checked = state.settings.manualThemeDark;
    dom.hourFormatToggle.checked = state.settings.is24Hour;
    dom.languageSelect.value = state.settings.language;

    applyLanguage();
    renderAlarms();
    
    let initialTimezone;
    try {
        const response = await fetch(`${API_BASE_URL}/ip`);
        if (!response.ok) throw new Error("IP API failed");
        initialTimezone = (await response.json()).timezone;
    } catch (e) {
        console.warn("IP lookup failed. Using browser's local timezone as fallback.");
        initialTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    }

    state.mainClock = await createClockObject(initialTimezone);
    if(state.mainClock) {
        const mainCity = cityData.find(c => c.timezone === state.mainClock.timezone);
        state.mainClock.name = mainCity ? mainCity.name : state.mainClock.timezone.split('/').pop().replace(/_/g, ' ');
        dom.mainLocation.textContent = state.mainClock.timezone.replace(/_/g, ' ');
    }
    
    applyTheme();
    renderPinnedClocks();
    setupEventListeners();
    setupSoundPlayer();

    changeQuote();
    
    updateAllClocks();
    clockUpdateInterval = setInterval(updateAllClocks, 1000);
    state.alarmCheckInterval = setInterval(checkAlarms, 1000);
};

init();
    </script>
</body>
</html>
